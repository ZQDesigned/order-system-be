# 订单系统设计文档

## 1. 系统概述

该订单系统支持用户提交自定义商品订单并通过系统配置的流程进行审核与处理。  
系统涉及三种用户角色：普通用户、代理、超管。  
用户通过动态生成的表单提交订单并接收订单凭证（二维码和链接）。  
代理与超管在后台管理系统中对订单进行审核与执行，系统通过邮件发送状态通知。

---

## 2. 技术架构

- 前端：Next.js（仅用于页面渲染）
- 后端：Spring Boot（REST API）
- 数据库：PostgreSQL
- ORM：JPA / MyBatis
- 邮件服务：Spring Mail
- 二维码：Google ZXing / 前端生成
- 权限控制：Spring Security + RBAC
- 验证码服务：Redis + 邮件验证码逻辑
- 限流措施：IP 限速 + 单邮箱/手机号限频机制

---

## 3. 用户角色与权限

**普通用户：**

- 无需登录
- 可提交订单、接收邮件通知、访问订单详情、修改或取消未审核订单（需邮箱验证）

**代理：**

- 登录后查看并审核自己负责的订单
- 可后台创建订单

**超管：**

- 审核代理审核通过的订单
- 可退回“待超管审核”状态的订单
- 执行订单、标记订单完成

---

## 4. 商品与动态表单配置

本系统支持 **每个商品定义一套独立的动态表单字段**，用户在提交订单时需填写与该商品绑定的表单内容。此能力使得系统支持高度灵活的商品类型配置，区别于传统订单系统中的固定字段结构。

### 字段类型支持：

- 文本（短文本输入）
- 数字（正/负数，可配置范围限制）
- 单选（Radio）
- 多选（Checkbox）

### 字段配置属性：

- **字段名称**：显示名称
- **字段标识符**（字段 key）：用于数据库存储与回显
- **字段类型**：见上
- **是否必填**：控制表单校验逻辑
- **校验规则**：支持正则表达式、自定义提示
- **字段提示语**：用于前端显示说明
- **选项值（适用于单选/多选）**：每项的值与展示名称

### 配置方式：

- 管理员在后台创建/编辑商品时，可通过可视化表单生成器进行字段定义
- 字段顺序、逻辑控制可支持拖拽配置（建议后期支持）
- 商品上架后，用户访问时自动根据字段配置渲染动态表单

### 数据存储模型：

订单提交后，用户填写的所有字段将以“键值对”形式存储在 `order_fields` 表中：

| 字段名     | 类型   | 示例                       |
| ---------- | ------ | -------------------------- |
| order_id   | UUID   | 123e4567-e89b-12d3-a456…   |
| field_key  | string | "company_name"             |
| field_type | string | "text"                     |
| field_val  | string | "OpenAI Singapore Pte Ltd" |

此设计支持任意商品字段结构扩展，避免修改数据库表结构。

### 校验与前端联动：

- 前端基于配置动态生成输入控件
- 校验规则实时生效
- 表单配置变更立即影响用户端，无需二次开发

---

> 该模块为本系统的核心灵活性来源，是支持多品类订单场景的重要能力。

---

## 5. 订单流程与状态

1. 用户提交订单（邮箱验证）
2. 若存在代理：代理审核 -> 超管审核 -> 执行订单 -> 完成  
   若无代理：直接进入超管审核

**状态包括：**

- 待代理审核
- 待超管审核
- 订单进行中
- 已完成
- 已退回
- 已取消（用户在未审核前可取消）

---

## 6. 订单凭证与访问

- 用户提交成功后返回一个二维码（前端渲染）和一个访问链接
- 链接示例：/order/{id}?token=xxx
- 所有订单详情和修改操作均需邮箱验证码验证
- 验证码有效期10分钟，120秒内不可重发

---

## 7. 通知与邮件

- 所有订单状态变更通过邮件发送给用户
- 邮件发送由 Spring Mail 实现
- 邮件内容基于模板生成

---

## 8. 管理后台功能

- 商品管理：字段配置管理
- 订单管理：按状态筛选、搜索、分页查看
- 日志管理：记录每一次审核、退回、状态修改等操作
- 角色管理：代理与超管权限分离

---

## 9. 安全控制与防滥用机制

- 所有用户敏感操作均需邮箱验证码校验
- Redis 存储验证码与过期机制
- 用户邮箱与 IP 提交频率限制（如：每小时最多提交 50 单）
- Spring Security 控制管理端权限

---

## 10. 数据库结构简述

- users（代理与超管用户）
- products（商品信息）
- product_fields（商品字段定义）
- orders（订单主表）
- order_fields（订单字段值）
- verification_codes（验证码记录）
- order_logs（订单操作日志）
